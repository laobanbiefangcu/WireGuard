# WireGuard VPN 管理工具

一个功能完整的 WireGuard VPN 安装、管理和维护脚本，支持一键部署和图形化管理。

## ✨ 功能特性

### 🚀 核心功能
- **一键安装**：自动安装并配置 WireGuard VPN 服务
- **智能管理**：图形化菜单界面，操作简单直观
- **多客户端支持**：默认创建 10 个客户端配置
- **链接生成**：自动生成 `wireguard://` 链接，支持一键导入
- **配置备份**：自动备份现有配置，防止数据丢失
- **一键卸载**：完整清理所有相关文件和配置

### 🌐 网络特性
- **双栈支持**：同时支持 IPv4 和 IPv6
- **智能检测**：自动检测网卡接口和网络环境
- **网段选择**：支持多种预设网段和自定义网段
- **防火墙配置**：自动配置 iptables/ip6tables 规则

### 🔒 安全特性
- **密钥管理**：自动生成和管理所有密钥
- **权限检查**：严格的 root 权限验证
- **配置验证**：安装后自动验证配置正确性
- **备份机制**：时间戳命名的自动备份

## 📋 系统要求

### 支持的操作系统
- Ubuntu 18.04+
- Debian 9+
- CentOS 7+/RHEL 7+
- 其他基于 systemd 的 Linux 发行版

### 系统要求
- **权限**：需要 root 权限
- **内核**：Linux Kernel 3.10+（推荐 5.6+）
- **网络**：需要互联网连接用于软件包安装
- **存储**：至少 50MB 可用空间

## 🚀 快速开始

### 1. 下载脚本
```bash
wget https://example.com/wireguard_final.sh
# 或
curl -O https://example.com/wireguard_final.sh
```

### 2. 设置权限
```bash
chmod +x wireguard_final.sh
```

### 3. 运行脚本
```bash
sudo ./wireguard_final.sh
```

### 4. 选择功能
脚本启动后会显示主菜单：

```
╔══════════════════════════════════════════════════════════╗
║           WireGuard VPN 管理工具 v2.2.0                 ║
╠══════════════════════════════════════════════════════════╣
║  1. 安装/重新安装 WireGuard VPN                         ║
║  2. 查看所有客户端链接                                  ║
║  3. 查看指定客户端链接                                  ║
║  4. 提取纯净链接（无格式）                              ║
║  5. 查看服务状态                                        ║
║  6. 一键卸载 WireGuard                                 ║
║  0. 退出                                                ║
╚══════════════════════════════════════════════════════════╝
```

## 📖 详细使用说明

### 安装 WireGuard（选项1）

1. **选择服务器IP类型**：
   - IPv4 地址（推荐）
   - IPv6 地址
   - 手动输入

2. **选择IPv4网段**：
   - 192.168.3.0/24（默认）
   - 10.0.0.0/24
   - 172.16.0.0/24
   - 自定义网段

3. **自动配置**：
   - 生成服务端和客户端密钥
   - 创建配置文件
   - 设置防火墙规则
   - 启动 WireGuard 服务
   - 生成客户端链接

### 查看客户端链接（选项2/3/4）

**选项2 - 完整格式显示**：
```
[OK] ======== 客户端 1 ========
wireguard://xxx...#wg_ubuntu_1
----------------------------------------
[OK] ======== 客户端 2 ========
wireguard://xxx...#wg_ubuntu_2
```

**选项3 - 查看指定客户端**：
- 输入客户端编号（1-10）
- 显示该客户端的详细配置

**选项4 - 纯净链接提取**：
```
wireguard://xxx...#wg_ubuntu_1
wireguard://xxx...#wg_ubuntu_2
wireguard://xxx...#wg_ubuntu_3
```

### 服务状态检查（选项5）
显示详细的服务状态信息：
- WireGuard 服务运行状态
- 网络接口状态
- 连接的客户端信息
- 流量统计

### 一键卸载（选项6）
完整清理所有相关文件：
- 停止 WireGuard 服务
- 删除配置文件
- 清理防火墙规则
- 移除软件包（可选）

## 📁 文件结构

安装完成后会创建以下文件：

```
/etc/wireguard/
├── wg0.conf                    # 服务端配置
├── wg_ubuntu_1.conf           # 客户端1配置
├── wg_ubuntu_1.wg             # 客户端1链接
├── wg_ubuntu_1.png            # 客户端1二维码
├── ...                        # 其他客户端文件
├── sprivatekey                # 服务端私钥
├── spublickey                 # 服务端公钥
└── backup/                    # 备份目录
    └── 20231210_143022/       # 时间戳备份
```

## ⚙️ 配置说明

### 默认配置
- **端口**：51820/udp
- **MTU**：1420
- **客户端数量**：10个
- **IPv4网段**：192.168.3.0/24
- **DNS服务器**：119.29.29.29, 2402:4e00::

### 网络配置
- **IPv4地址分配**：192.168.3.2 ~ 192.168.3.11
- **IPv6地址分配**：自动检测本地IPv6前缀
- **路由设置**：全流量代理（0.0.0.0/0, ::/0）

## 🔧 高级配置

### 环境变量支持
```bash
# 强制安装模式
export FORCE_INSTALL=1

# 静默模式
export QUIET_MODE=1

# 自定义网段
export WG_IPV4_NETWORK="10.0.0"

# 自定义端口
export WG_PORT=52820
```

### 批量部署
```bash
# 使用预设参数批量安装
echo "1" | sudo WG_IPV4_NETWORK="10.0.0" ./wireguard_final.sh
```

## 🛠️ 故障排除

### 常见问题

**1. 权限错误**
```bash
# 确保使用 root 权限
sudo ./wireguard_final.sh
```

**2. 端口被占用**
```bash
# 检查端口使用情况
netstat -nlup | grep 51820
```

**3. IPv6 不支持**
```bash
# 检查 IPv6 支持
cat /proc/net/if_inet6
```

**4. 防火墙问题**
```bash
# 检查防火墙状态
iptables -L FORWARD
ip6tables -L FORWARD
```

### 日志文件
查看详细日志：
```bash
tail -f /var/log/wireguard-install.log
```

### 手动验证
```bash
# 检查服务状态
systemctl status wg-quick@wg0

# 检查网络接口
wg show

# 测试配置文件
wg-quick strip wg0
```

## 🔐 安全注意事项

### 密钥安全
- 服务端私钥仅存储在服务器
- 定期备份配置文件
- 客户端配置分发后建议删除服务器副本

### 网络安全
- 定期更新系统和 WireGuard
- 监控异常连接
- 配置适当的防火墙规则

### 访问控制
- 限制脚本执行权限
- 定期审查客户端列表
- 及时撤销不需要的客户端

## 📊 性能优化

### 服务器配置
- **CPU**：2核心+ （支持50+并发连接）
- **内存**：1GB+ （建议2GB+）
- **带宽**：根据用户数量配置

### 系统优化
```bash
# 优化内核参数
echo 'net.core.default_qdisc=fq' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_congestion_control=bbr' >> /etc/sysctl.conf
sysctl -p
```

## 🤝 技术支持

### 获取帮助
1. 查看日志文件找到错误信息
2. 检查系统兼容性
3. 验证网络环境配置
4. 参考故障排除章节

### 版本信息
- **当前版本**：v2.2.0
- **更新日期**：2025年8月
- **兼容性**：WireGuard 1.0+

## 📄 许可证

本项目采用 MIT 许可证，详情请查看 LICENSE 文件。

## 🙏 致谢

感谢 WireGuard 项目和开源社区的贡献。

---

**⚠️ 免责声明**：请遵守当地法律法规，仅用于合法用途。使用本工具产生的任何问题由用户自行承担责任。